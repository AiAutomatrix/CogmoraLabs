rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rules for the main application user data (paper trading, etc.)
    // This allows a user full read/write access to their own data silo.
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rules for the "Run Payments with Stripe" Firebase Extension
    
    // Customer documents:
    // A user can read their own customer document.
    // They can also create their own customer document, which is necessary
    // for the very first checkout session they create.
    match /customers/{userId} {
      allow read, create: if request.auth.uid == userId;

      // Checkout sessions:
      // A user can create, read, and update their own checkout session documents.
      // This is the CRITICAL rule that was missing/incorrect. It allows the
      // client to initiate a payment.
      match /checkout_sessions/{sessionId} {
        allow create, read, update: if request.auth.uid == userId;
      }

      // Subscriptions and payments are read-only for the user.
      // The extension writes to these with admin privileges.
      match /subscriptions/{subscriptionId} {
        allow read: if request.auth.uid == userId;
      }
      match /payments/{paymentId} {
        allow read: if request.auth.uid == userId;
      }
    }

    // Product and pricing information is public and read-only for all clients.
    match /products/{productId} {
      allow read: if true;
      allow write: if false;

      match /prices/{priceId} {
        allow read: if true;
        allow write: if false;
      }
    }
  }
}
