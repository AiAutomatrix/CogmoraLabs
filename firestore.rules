rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the top-level user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile.
     * @allow (get) - Authenticated user can read their own profile.
     * @allow (update) - Authenticated user can update their own profile.
     * @allow (delete) - Authenticated user can delete their own profile.
     * @deny (list) - Prevents listing all user profiles.
     * @deny (create) - Unauthenticated users cannot create profiles.
     * @deny (update) - Authenticated user cannot update another user's profile.
     * @deny (delete) - Authenticated user cannot delete another user's profile.
     * @principle Enforces user ownership and prevents unauthorized access to user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the paper trading context for a user.
     * @path /users/{userId}/paperTradingContext/main
     * @allow (create) - Authenticated user can create their own paper trading context.
     * @allow (get) - Authenticated user can read their own paper trading context.
     * @allow (update) - Authenticated user can update their own paper trading context.
     * @allow (delete) - Authenticated user can delete their own paper trading context.
     * @deny (create) - Unauthenticated users cannot create paper trading contexts.
     * @deny (update) - Authenticated user cannot update another user's paper trading context.
     * @deny (delete) - Authenticated user cannot delete another user's paper trading context.
     * @principle Enforces user ownership and prevents unauthorized access to paper trading context.
     */
    match /users/{userId}/paperTradingContext/main {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the open positions for a user.
     * @path /users/{userId}/paperTradingContext/main/openPositions/{positionId}
     * @allow (create) - Authenticated user can create their own open position.
     * @allow (get) - Authenticated user can read their own open position.
     * @allow (update) - Authenticated user can update their own open position.
     * @allow (delete) - Authenticated user can delete their own open position.
     * @allow (list) - Authenticated user can list their own open positions.
     * @deny (create) - Unauthenticated users cannot create open positions.
     * @deny (update) - Authenticated user cannot update another user's open position.
     * @deny (delete) - Authenticated user cannot delete another user's open position.
     * @principle Enforces user ownership and prevents unauthorized access to open positions.
     */
    match /users/{userId}/paperTradingContext/main/openPositions/{positionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the trade history for a user.
     * @path /users/{userId}/paperTradingContext/main/tradeHistory/{tradeId}
     * @allow (create) - Authenticated user can create their own trade history.
     * @allow (get) - Authenticated user can read their own trade history.
     * @allow (update) - Authenticated user can update their own trade history.
     * @allow (delete) - Authenticated user can delete their own trade history.
     * @allow (list) - Authenticated user can list their own trade history.
     * @deny (create) - Unauthenticated users cannot create trade history.
     * @deny (update) - Authenticated user cannot update another user's trade history.
     * @deny (delete) - Authenticated user cannot delete another user's trade history.
     * @principle Enforces user ownership and prevents unauthorized access to trade history.
     */
    match /users/{userId}/paperTradingContext/main/tradeHistory/{tradeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the watchlist for a user.
     * @path /users/{userId}/paperTradingContext/main/watchlist/{symbol}
     * @allow (create) - Authenticated user can create their own watchlist.
     * @allow (get) - Authenticated user can read their own watchlist.
     * @allow (update) - Authenticated user can update their own watchlist.
     * @allow (delete) - Authenticated user can delete their own watchlist.
     * @allow (list) - Authenticated user can list their own watchlist.
     * @deny (create) - Unauthenticated users cannot create watchlists.
     * @deny (update) - Authenticated user cannot update another user's watchlist.
     * @deny (delete) - Authenticated user cannot delete another user's watchlist.
     * @principle Enforces user ownership and prevents unauthorized access to watchlist.
     */
    match /users/{userId}/paperTradingContext/main/watchlist/{symbol} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the trade triggers for a user.
     * @path /users/{userId}/paperTradingContext/main/tradeTriggers/{triggerId}
     * @allow (create) - Authenticated user can create their own trade trigger.
     * @allow (get) - Authenticated user can read their own trade trigger.
     * @allow (update) - Authenticated user can update their own trade trigger.
     * @allow (delete) - Authenticated user can delete their own trade trigger.
     * @allow (list) - Authenticated user can list their own trade triggers.
     * @deny (create) - Unauthenticated users cannot create trade triggers.
     * @deny (update) - Authenticated user cannot update another user's trade trigger.
     * @deny (delete) - Authenticated user cannot delete another user's trade trigger.
     * @principle Enforces user ownership and prevents unauthorized access to trade triggers.
     */
    match /users/{userId}/paperTradingContext/main/tradeTriggers/{triggerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects the price alerts for a user.
     * @path /users/{userId}/paperTradingContext/main/priceAlerts/{symbol}
     * @allow (create) - Authenticated user can create their own price alert.
     * @allow (get) - Authenticated user can read their own price alert.
     * @allow (update) - Authenticated user can update their own price alert.
     * @allow (delete) - Authenticated user can delete their own price alert.
     * @allow (list) - Authenticated user can list their own price alerts.
     * @deny (create) - Unauthenticated users cannot create price alerts.
     * @deny (update) - Authenticated user cannot update another user's price alert.
     * @deny (delete) - Authenticated user cannot delete another user's price alert.
     * @principle Enforces user ownership and prevents unauthorized access to price alerts.
     */
    match /users/{userId}/paperTradingContext/main/priceAlerts/{symbol} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}