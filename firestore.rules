/**
 * @fileoverview Firestore Security Rules for Cogmora Labs application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model.  Each user has a dedicated data tree rooted at `/users/{userId}`.
 * All data within this tree is exclusively accessible and modifiable by the owning user.
 *
 * Data Structure:
 * - `/users/{userId}`: User profile data.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}`:  Paper trading context.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}/trades/{tradeId}`: Trade history.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}/tradeTriggers/{tradeTriggerId}`: Trade triggers/alerts.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}/openPositions/{openPositionId}`: Open positions.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}/aiSettings/{aiSettingsId}`: AI settings.
 * - `/users/{userId}/paperTradingContexts/{paperTradingContextId}/automationConfigs/{automationConfigId}`: Automation configurations.
 * - `/users/{userId}/notifications/{notificationId}`: User notifications.
 *
 * Key Security Decisions:
 * - Strict User Ownership: All reads and writes are restricted to the owning user via the `isOwner(userId)` function.
 * - No User Listing: Listing all users is disallowed for privacy and security reasons.
 * - Data Denormalization:  The data model is designed to avoid complex `get()` calls within the rules. Relationships are enforced through path-based rules (e.g., a Trade document's location implies its `paperTradingContextId` and `userId`).
 * - Self-Creation: Users can create their own profile document at `/users/{userId}` using their authenticated UID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the user profile collection. Only the owner can read and write their profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their profile document at /users/user_abc.
     * @allow (get) User with UID 'user_abc' can read their profile document at /users/user_abc.
     * @allow (update) User with UID 'user_abc' can update their profile document at /users/user_abc.
     * @allow (delete) User with UID 'user_abc' can delete their profile document at /users/user_abc.
     * @deny (create) User with UID 'user_xyz' cannot create a profile document at /users/user_abc.
     * @deny (get) User with UID 'user_xyz' cannot read the profile document at /users/user_abc.
     * @deny (update) User with UID 'user_xyz' cannot update the profile document at /users/user_abc.
     * @deny (delete) User with UID 'user_xyz' cannot delete the profile document at /users/user_abc.
     * @principle Enforces document ownership for all operations. Allows self-creation.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is disallowed.

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the paper trading context collection. Only the owner can read and write their paper trading context.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}
     * @allow (create) User with UID 'user_abc' can create a paper trading context under /users/user_abc/paperTradingContexts/ptc_123.
     * @allow (get) User with UID 'user_abc' can read the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @allow (update) User with UID 'user_abc' can update the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @allow (delete) User with UID 'user_abc' can delete the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @deny (create) User with UID 'user_xyz' cannot create a paper trading context under /users/user_abc/paperTradingContexts/ptc_123.
     * @deny (get) User with UID 'user_xyz' cannot read the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @deny (update) User with UID 'user_xyz' cannot update the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @deny (delete) User with UID 'user_xyz' cannot delete the paper trading context at /users/user_abc/paperTradingContexts/ptc_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the trade collection. Only the owner can read and write their trades.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}/trades/{tradeId}
     * @allow (create) User with UID 'user_abc' can create a trade under /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @allow (get) User with UID 'user_abc' can read the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @allow (update) User with UID 'user_abc' can update the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @allow (delete) User with UID 'user_abc' can delete the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @deny (create) User with UID 'user_xyz' cannot create a trade under /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @deny (get) User with UID 'user_xyz' cannot read the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @deny (update) User with UID 'user_xyz' cannot update the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @deny (delete) User with UID 'user_xyz' cannot delete the trade at /users/user_abc/paperTradingContexts/ptc_123/trades/trade_456.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId}/trades/{tradeId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow update: if isExistingOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the trade trigger collection. Only the owner can read and write their trade triggers.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}/tradeTriggers/{tradeTriggerId}
     * @allow (create) User with UID 'user_abc' can create a trade trigger under /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @allow (get) User with UID 'user_abc' can read the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @allow (update) User with UID 'user_abc' can update the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @allow (delete) User with UID 'user_abc' can delete the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @deny (create) User with UID 'user_xyz' cannot create a trade trigger under /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @deny (get) User with UID 'user_xyz' cannot read the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @deny (update) User with UID 'user_xyz' cannot update the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @deny (delete) User with UID 'user_xyz' cannot delete the trade trigger at /users/user_abc/paperTradingContexts/ptc_123/tradeTriggers/trigger_789.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId}/tradeTriggers/{tradeTriggerId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow update: if isExistingOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the open position collection. Only the owner can read and write their open positions.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}/openPositions/{openPositionId}
     * @allow (create) User with UID 'user_abc' can create an open position under /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @allow (get) User with UID 'user_abc' can read the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @allow (update) User with UID 'user_abc' can update the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @allow (delete) User with UID 'user_abc' can delete the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @deny (create) User with UID 'user_xyz' cannot create an open position under /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @deny (get) User with UID 'user_xyz' cannot read the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @deny (update) User with UID 'user_xyz' cannot update the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @deny (delete) User with UID 'user_xyz' cannot delete the open position at /users/user_abc/paperTradingContexts/ptc_123/openPositions/pos_abc.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId}/openPositions/{openPositionId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow update: if isExistingOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the AI settings collection. Only the owner can read and write their AI settings.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}/aiSettings/{aiSettingsId}
     * @allow (create) User with UID 'user_abc' can create AI settings under /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @allow (get) User with UID 'user_abc' can read the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @allow (update) User with UID 'user_abc' can update the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @allow (delete) User with UID 'user_abc' can delete the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @deny (create) User with UID 'user_xyz' cannot create AI settings under /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @deny (get) User with UID 'user_xyz' cannot read the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @deny (update) User with UID 'user_xyz' cannot update the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @deny (delete) User with UID 'user_xyz' cannot delete the AI settings at /users/user_abc/paperTradingContexts/ptc_123/aiSettings/ai_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId}/aiSettings/{aiSettingsId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow update: if isExistingOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the automation configuration collection. Only the owner can read and write their automation configurations.
     * @path /users/{userId}/paperTradingContexts/{paperTradingContextId}/automationConfigs/{automationConfigId}
     * @allow (create) User with UID 'user_abc' can create an automation config under /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @allow (get) User with UID 'user_abc' can read the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @allow (update) User with UID 'user_abc' can update the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @allow (delete) User with UID 'user_abc' can delete the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @deny (create) User with UID 'user_xyz' cannot create an automation config under /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @deny (get) User with UID 'user_xyz' cannot read the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @deny (update) User with UID 'user_xyz' cannot update the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @deny (delete) User with UID 'user_xyz' cannot delete the automation config at /users/user_abc/paperTradingContexts/ptc_123/automationConfigs/auto_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/paperTradingContexts/{paperTradingContextId}/automationConfigs/{automationConfigId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow update: if isExistingOwner(userId) && request.resource.data.paperTradingContextId == paperTradingContextId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the notification collection. Only the owner can read and write their notifications.
     * @path /users/{userId}/notifications/{notificationId}
     * @allow (create) User with UID 'user_abc' can create a notification under /users/user_abc/notifications/notif_123.
     * @allow (get) User with UID 'user_abc' can read the notification at /users/user_abc/notifications/notif_123.
     * @allow (update) User with UID 'user_abc' can update the notification at /users/user_abc/notifications/notif_123.
     * @allow (delete) User with UID 'user_abc' can delete the notification at /users/user_abc/notifications/notif_123.
     * @deny (create) User with UID 'user_xyz' cannot create a notification under /users/user_abc/notifications/notif_123.
     * @deny (get) User with UID 'user_xyz' cannot read the notification at /users/user_abc/notifications/notif_123.
     * @deny (update) User with UID 'user_xyz' cannot update the notification at /users/user_abc/notifications/notif_123.
     * @deny (delete) User with UID 'user_xyz' cannot delete the notification at /users/user_abc/notifications/notif_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/notifications/{notificationId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requested user ID matches the authenticated user ID.
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      // Helper function to check if the user is the existing owner of the document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId; // userId cannot be changed.
      allow delete: if isExistingOwner(userId);
    }
  }
}