{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Cogmora Labs platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "Display name of the user."
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        },
        "creationTime": {
          "type": "string",
          "description": "Timestamp of when the user account was created.",
          "format": "date-time"
        },
        "lastSignInTime": {
          "type": "string",
          "description": "Timestamp of when the user last signed in.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "displayName"
      ]
    },
    "PaperTradingContext": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PaperTradingContext",
      "type": "object",
      "description": "Represents the paper trading context for a user, including their balance, open positions, trade history, watchlist, triggers, automation configuration and AI settings.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the paper trading context."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 PaperTradingContext)"
        },
        "balance": {
          "type": "number",
          "description": "The user's current balance in their paper trading account."
        },
        "openPositionIds": {
          "type": "array",
          "description": "References to OpenPositions. (Relationship: PaperTradingContext 1:N OpenPosition)",
          "items": {
            "type": "string"
          }
        },
        "tradeHistoryIds": {
          "type": "array",
          "description": "References to TradeHistories. (Relationship: PaperTradingContext 1:N TradeHistory)",
          "items": {
            "type": "string"
          }
        },
        "watchList": {
          "type": "array",
          "description": "The user's watchlist, containing symbols to monitor.",
          "items": {
            "type": "string"
          }
        },
        "triggerIds": {
          "type": "array",
          "description": "References to Triggers. (Relationship: PaperTradingContext 1:N Trigger)",
          "items": {
            "type": "string"
          }
        },
        "automationConfig": {
          "type": "string",
          "description": "The user's automation configuration."
        },
        "aiSettings": {
          "type": "string",
          "description": "The user's AI settings."
        }
      },
      "required": [
        "id",
        "userId",
        "balance"
      ]
    },
    "OpenPosition": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OpenPosition",
      "type": "object",
      "description": "Represents an open position in the paper trading account.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the open position."
        },
        "paperTradingContextId": {
          "type": "string",
          "description": "Reference to PaperTradingContext. (Relationship: PaperTradingContext 1:N OpenPosition)"
        },
        "symbol": {
          "type": "string",
          "description": "The symbol of the open position (e.g., BTC-USDT)."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the asset in the open position."
        },
        "entryPrice": {
          "type": "number",
          "description": "The entry price of the open position."
        },
        "stopLoss": {
          "type": "number",
          "description": "The stop loss price for the open position."
        },
        "takeProfit": {
          "type": "number",
          "description": "The take profit price for the open position."
        },
        "openTime": {
          "type": "string",
          "description": "Timestamp of when the position was opened.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "paperTradingContextId",
        "symbol",
        "quantity",
        "entryPrice"
      ]
    },
    "TradeHistory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TradeHistory",
      "type": "object",
      "description": "Represents a historical trade in the paper trading account.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the trade history entry."
        },
        "paperTradingContextId": {
          "type": "string",
          "description": "Reference to PaperTradingContext. (Relationship: PaperTradingContext 1:N TradeHistory)"
        },
        "symbol": {
          "type": "string",
          "description": "The symbol of the traded asset (e.g., BTC-USDT)."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the asset traded."
        },
        "price": {
          "type": "number",
          "description": "The price at which the asset was traded."
        },
        "tradeTime": {
          "type": "string",
          "description": "Timestamp of when the trade occurred.",
          "format": "date-time"
        },
        "type": {
          "type": "string",
          "description": "The type of trade (e.g., buy, sell)."
        }
      },
      "required": [
        "id",
        "paperTradingContextId",
        "symbol",
        "quantity",
        "price",
        "tradeTime",
        "type"
      ]
    },
    "Trigger": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Trigger",
      "type": "object",
      "description": "Represents a trading trigger.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the trigger."
        },
        "paperTradingContextId": {
          "type": "string",
          "description": "Reference to PaperTradingContext. (Relationship: PaperTradingContext 1:N Trigger)"
        },
        "symbol": {
          "type": "string",
          "description": "The symbol the trigger is associated with (e.g., BTC-USDT)."
        },
        "condition": {
          "type": "string",
          "description": "The condition that must be met for the trigger to fire (e.g., price crosses above 30000)."
        },
        "action": {
          "type": "string",
          "description": "The action to take when the trigger fires (e.g., buy, sell)."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the asset to trade when the trigger fires."
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates whether the trigger is currently active."
        }
      },
      "required": [
        "id",
        "paperTradingContextId",
        "symbol",
        "condition",
        "action",
        "quantity",
        "isActive"
      ]
    },
    "SubscriptionTier": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubscriptionTier",
      "type": "object",
      "description": "Represents a subscription tier with associated features and limits.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the subscription tier."
        },
        "name": {
          "type": "string",
          "description": "Name of the subscription tier (e.g., Free, Premium)."
        },
        "price": {
          "type": "number",
          "description": "Price of the subscription tier per month."
        },
        "maxAiAnalysisRuns": {
          "type": "number",
          "description": "Maximum number of AI analysis runs allowed per day."
        },
        "cloudSync": {
          "type": "boolean",
          "description": "Indicates whether cloud synchronization is enabled for this tier."
        },
        "proFeatures": {
          "type": "boolean",
          "description": "Indicates whether Pro features are unlocked for this tier."
        }
      },
      "required": [
        "id",
        "name",
        "price",
        "maxAiAnalysisRuns",
        "cloudSync",
        "proFeatures"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information.  Owned by the user identified by {userId}.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paperTradingContexts/{paperTradingContextId}",
        "definition": {
          "entityName": "PaperTradingContext",
          "schema": {
            "$ref": "#/backend/entities/PaperTradingContext"
          },
          "description": "Stores the paper trading context for a specific user. The 'userId' is denormalized through the path to ensure authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "paperTradingContextId",
              "description": "The unique identifier for the paper trading context."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paperTradingContexts/{paperTradingContextId}/openPositions/{openPositionId}",
        "definition": {
          "entityName": "OpenPosition",
          "schema": {
            "$ref": "#/backend/entities/OpenPosition"
          },
          "description": "Stores open positions for a user's paper trading context. The 'userId' and 'paperTradingContextId' are denormalized through the path to ensure authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "paperTradingContextId",
              "description": "The unique identifier for the paper trading context."
            },
            {
              "name": "openPositionId",
              "description": "The unique identifier for the open position."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paperTradingContexts/{paperTradingContextId}/tradeHistories/{tradeHistoryId}",
        "definition": {
          "entityName": "TradeHistory",
          "schema": {
            "$ref": "#/backend/entities/TradeHistory"
          },
          "description": "Stores trade history for a user's paper trading context. The 'userId' and 'paperTradingContextId' are denormalized through the path to ensure authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "paperTradingContextId",
              "description": "The unique identifier for the paper trading context."
            },
            {
              "name": "tradeHistoryId",
              "description": "The unique identifier for the trade history entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paperTradingContexts/{paperTradingContextId}/triggers/{triggerId}",
        "definition": {
          "entityName": "Trigger",
          "schema": {
            "$ref": "#/backend/entities/Trigger"
          },
          "description": "Stores trading triggers for a user's paper trading context. The 'userId' and 'paperTradingContextId' are denormalized through the path to ensure authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "paperTradingContextId",
              "description": "The unique identifier for the paper trading context."
            },
            {
              "name": "triggerId",
              "description": "The unique identifier for the trigger."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the Cogmora Labs application, emphasizing security, scalability, and debuggability, following the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), QAPs (Rules are not Filters), and Invariants.\n\nAuthorization Independence is achieved through denormalization. Specifically, for user-owned data like PaperTradingContext, OpenPositions, TradeHistory, and Triggers, the userId is implicitly included in the path itself (e.g., `/users/{userId}/paperTradingContexts/{paperTradingContextId}`).  If access to a resource depended on a user's subscription tier (a potential future enhancement), the subscription tier data would be denormalized into the user's document or the relevant subcollections.\n\nStructural Segregation is used to ensure that all documents within a collection share the same security requirements. Each user's data is stored under their respective `/users/{userId}` path, ensuring that only the user (and admins) can access it. This prevents mixing data with different access needs in the same collection.\n\nAccess Modeling follows a consistent pattern:  Path-based ownership is used for private user data.  For collaborative data models, the Membership Map pattern could be applied in future enhancements if collaborative features are introduced.\n\nThe structure also supports required QAPs. Secure list operations are enabled by structural segregation.  Rules can easily filter based on the `request.auth.uid` without needing to perform expensive `get()` operations.\n\nFinally, the structure helps enforce invariants like ownership by embedding the `userId` in the document path. Timestamps can be enforced within security rules using `request.time`.\n\nDenormalization allows to avoid `get()` calls in security rules, improving performance and security, and allowing atomic operations."
  }
}